const { CognitoJwtVerifier } = require('aws-jwt-verify');
require('dotenv').config();

// Verificar si las variables de entorno est√°n disponibles
let verifier = null;
try {
  if (process.env.COGNITO_USER_POOL_ID && process.env.COGNITO_CLIENT_ID) {
    verifier = CognitoJwtVerifier.create({
      userPoolId: process.env.COGNITO_USER_POOL_ID,
      tokenUse: 'id',
      clientId: process.env.COGNITO_CLIENT_ID
    });
    console.log('‚úÖ AWS Cognito verificador inicializado');
  } else {
    console.warn('‚ö†Ô∏è Configuraci√≥n de AWS Cognito no encontrada, autenticaci√≥n deshabilitada para desarrollo');
  }
} catch (error) {
  console.warn('‚ö†Ô∏è Error inicializando AWS Cognito:', error.message);
  console.warn('‚ö†Ô∏è Continuando sin autenticaci√≥n para desarrollo');
}

// Middleware de autenticaci√≥n
const authenticate = async (req, res, next) => {
  try {
    // Si no hay verifier configurado, saltar autenticaci√≥n en desarrollo
    if (!verifier) {
      if (process.env.NODE_ENV === 'development') {
        console.warn('‚ö†Ô∏è Saltando autenticaci√≥n (modo desarrollo sin Cognito)');
        // Crear un usuario falso para desarrollo
        req.user = {
          email: 'dev@example.com',
          permissions: {
            role: 'admin',
            canUpload: true,
            canViewFunds: true,
            permissionsLoaded: true
          }
        };
        return next();
      } else {
        return res.status(500).json({
          error: 'Autenticaci√≥n no configurada',
          code: 'AUTH_NOT_CONFIGURED'
        });
      }
    }
    
    // Obtener token del header Authorization
    const authHeader = req.headers.authorization;
    
    if (!authHeader) {
      return res.status(401).json({
        error: 'Token de autorizaci√≥n requerido',
        code: 'NO_TOKEN'
      });
    }

    // Extraer token (formato: "Bearer <token>")
    const token = authHeader.split(' ')[1];
    
    if (!token) {
      return res.status(401).json({
        error: 'Formato de token inv√°lido. Use: Bearer <token>',
        code: 'INVALID_TOKEN_FORMAT'
      });
    }

    // Verificar y decodificar el token
    const payload = await verifier.verify(token);
    
    // Agregar informaci√≥n del usuario a la request
    req.user = payload;
    req.user.permissions = {
      role: payload['custom:role'] || 'user',
      canUpload: payload['custom:can_upload'] === 'true',
      canViewFunds: payload['custom:can_view_funds'] === 'true',
      permissionsLoaded: payload['custom:permissions_loaded'] === 'true'
    };

    console.log(`üîê Usuario autenticado: ${req.user.email} (${req.user.permissions.role})`);
    next();
    
  } catch (error) {
    console.error('‚ùå Error de autenticaci√≥n:', error.message);
    
    // Manejar diferentes tipos de errores
    if (error.name === 'JwtExpiredError') {
      return res.status(401).json({
        error: 'Token expirado',
        code: 'TOKEN_EXPIRED'
      });
    }
    
    if (error.name === 'JsonWebTokenError') {
      return res.status(401).json({
        error: 'Token inv√°lido',
        code: 'INVALID_TOKEN'
      });
    }
    
    return res.status(401).json({
      error: 'Error de autenticaci√≥n',
      code: 'AUTH_ERROR',
      details: process.env.NODE_ENV === 'development' ? error.message : undefined
    });
  }
};

// Middleware para verificar permisos espec√≠ficos
const requirePermission = (permission) => {
  return (req, res, next) => {
    if (!req.user) {
      return res.status(401).json({
        error: 'Usuario no autenticado',
        code: 'NOT_AUTHENTICATED'
      });
    }

    // Verificar permisos espec√≠ficos
    switch (permission) {
      case 'upload':
        if (!req.user.permissions.canUpload) {
          return res.status(403).json({
            error: 'No tienes permisos para subir archivos',
            code: 'PERMISSION_DENIED'
          });
        }
        break;
        
      case 'view_funds':
        if (!req.user.permissions.canViewFunds) {
          return res.status(403).json({
            error: 'No tienes permisos para ver informaci√≥n de fondos',
            code: 'PERMISSION_DENIED'
          });
        }
        break;
        
      case 'admin':
        if (req.user.permissions.role !== 'admin') {
          return res.status(403).json({
            error: 'Se requieren permisos de administrador',
            code: 'ADMIN_REQUIRED'
          });
        }
        break;
        
      default:
        return res.status(500).json({
          error: 'Permiso no reconocido',
          code: 'UNKNOWN_PERMISSION'
        });
    }

    console.log(`‚úÖ Permiso verificado: ${permission} para ${req.user.email}`);
    next();
  };
};

// Middleware para logging de requests autenticados
const logAuthenticatedRequest = (req, res, next) => {
  if (req.user) {
    console.log(`üìù ${req.method} ${req.path} - Usuario: ${req.user.email} (${req.user.permissions.role})`);
  }
  next();
};

module.exports = {
  authenticate,
  requirePermission,
  logAuthenticatedRequest
};
